Project finance_app {
  database_type: "PostgreSQL"
  note: "High-level data model for personal finance app, structured by domains for dbdiagram.io"
}

// =========================
// Identity & Configuration
// =========================

Table users {
  id              uuid [pk, default: `gen_random_uuid()`]
  full_name       varchar(255)
  locale          varchar(10)  // e.g. es-CO
  created_at      timestamptz [not null, default: `now()`]
  updated_at      timestamptz [not null, default: `now()`]
  is_active       boolean [not null, default: true]
}

Table auth_identities {
  id uuid [pk]
  user_id                uuid [not null, unique]
  provider            varchar
  provider_id         varchar
  provider_metadata     jsonb
  created_at      timestamptz [not null, default: `now()`]
  updated_at      timestamptz [not null, default: `now()`]
}

Table user_settings {
  id                    uuid [pk, default: `gen_random_uuid()`]
  user_id               uuid [not null, unique]
  default_currency varchar(3) [not null]
  // future: notification prefs, time zone, etc.
}

// =========================
// Core Accounting Domain
// =========================

Table accounts {
  id                 uuid [pk, default: `gen_random_uuid()`]
  user_id            uuid [not null, ref: > users.id]
  name               varchar(255) [not null]
  institution_name   varchar(255) // e.g. Bancolombia, Nubank
  type               varchar(50) [not null] // account type: CASH, CHECKING, SAVINGS, CREDIT_CARD, LOAN_ASSET, LOAN_LIABILITY, WALLET, OTHER
  currency          varchar(3)   [not null]
  initial_balance    numeric(18,2) [not null, default: 0]
  is_archived        boolean [not null, default: false]
  opened_at          date
  closed_at          date
  created_at         timestamptz [not null, default: `now()`]
  updated_at         timestamptz [not null, default: `now()`]
}

Table categories {
  id          uuid [pk, default: `gen_random_uuid()`]
  user_id     uuid [not null, ref: > users.id]
  name        varchar(255) [not null]
  created_at  timestamptz [not null, default: `now()`]
}

Table tags {
  id          uuid [pk, default: `gen_random_uuid()`]
  user_id     uuid [not null, ref: > users.id]
  name        varchar(100) [not null]
  created_at  timestamptz [not null, default: `now()`]
}

Table transactions {
  id                 uuid [pk, default: `gen_random_uuid()`]
  user_id            uuid [not null, ref: > users.id]
  account_id         uuid [not null, ref: > accounts.id]
  direction          varchar(20) [not null] // INBOUND, OUTBOUND
  amount             numeric(18,2) [not null] // positive numbers, direction inferred from type
  currency          varchar(3) [not null]
  description        text
  category_id        uuid [ref: > categories.id]
  occurred_at        timestamptz [not null]
  external_ref       varchar(255) // bank reference / id
  created_at         timestamptz [not null, default: `now()`]
  updated_at         timestamptz [not null, default: `now()`]
}

Table transaction_tags {
  transaction_id uuid [not null, ref: > transactions.id]
  tag_id         uuid [not null, ref: > tags.id]

  indexes {
    (transaction_id, tag_id) [unique]
  }
}

// Explicit transfer aggregate to avoid double-counting
Table account_transfers {
  id               uuid [pk, default: `gen_random_uuid()`]
  user_id          uuid [not null, ref: > users.id]
  from_account_id  uuid [not null, ref: > accounts.id]
  to_account_id    uuid [not null, ref: > accounts.id]
  amount           numeric(18,2) [not null]
  currency        varchar(3) [not null]
  description      text
  executed_at      timestamptz [not null]
  created_at       timestamptz [not null, default: `now()`]
}

// =========================
// Statements & Import / AI
// =========================

Table files {
  id            uuid [pk, default: `gen_random_uuid()`]
  user_id       uuid [not null, ref: > users.id]
  file_name     varchar(500) [not null]
  file_type     varchar(100)
  file_size     bigint
  storage_path  varchar(1000) [not null]
  created_at    timestamptz [not null, default: `now()`]
}

Table imported_statements {
  id                uuid [pk, default: `gen_random_uuid()`]
  user_id           uuid [not null, ref: > users.id]
  account_id        uuid [ref: > accounts.id]
  file_id           uuid [ref: > files.id]
  provider          varchar(100) // Bancolombia, Nubank, etc.
  period_start      date
  period_end        date
  suggested_account_id uuid [not null, ref: > accounts.id]
  error_message     text
  uploaded_at       timestamptz [not null, default: `now()`]
  processed_at      timestamptz
}

Table imported_statement_items {
  id                uuid [pk, default: `gen_random_uuid()`]
  statement_id      uuid [not null, ref: > imported_statements.id]
  raw_date          varchar(50)
  raw_description   text
  raw_amount        varchar(50)
  raw_balance       varchar(50)
  parsed_date       timestamptz
  parsed_amount     numeric(18,2)
  parsed_direction       varchar(20)  // INBOUND, OUTBOUND
  suggested_category_id uuid [ref: > categories.id]
  matched_transaction_id uuid [ref: > transactions.id]
  created_at        timestamptz [not null, default: `now()`]
}
